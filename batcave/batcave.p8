pico-8 cartridge // http://www.pico-8.com
version 29
__lua__
-- bat cave
-- by arnaud lauret

function _init()
	game_over=false
	game_started=false
	make_cave()
	make_player()
end

function _update()
	if(game_started) then
		if(game_over) then
			if(btn(btn_x)) _init() --restart
		else -- playing	
			update_cave()
			move_player()
			check_hit()
		end
	else -- welcome screen
		if (btn(btn_x)) then
			game_started=true
			sfx_stop_all()
		end
	end
end

function _draw()
	cls()
	draw_cave()
	draw_player()
	
	if not game_started then
		print_center("bat cave",44,7)
		print_center("press ❎ to start",54,6)
	elseif game_over then
		print_center("game over!",44,7)
		print_center("your score:"..player.score,54,7)
		print_center("press ❎ to play again!",72,6)
	else
		print("score:"..player.score,2,2,7)
	end
end
-->8
function make_player()
	player={}
	player.x=24 --position
	player.y=60
	player.gravity=0.2 -- bigger means falls faster
	player.y_speed=0 --fallspeed
	player.dy_up=5 --when up pressed  
	player.spr_up=4 --sprites
	player.spr_down=5
	player.spr_dead=6
	player.x_speed=2 --horizontal speed
	player.score=0
	player.sfx_up=0  -- sfx when flapping
	player.sfx_dead=1
end

function draw_player()
	local sprite
	if(game_over) then
		sprite=player.spr_dead
	elseif player.y_speed<0 then
		sprite=player.spr_up
	else
		sprite=player.spr_down
	end
	spr(sprite,player.x,player.y)
end

function move_player()
	-- player falls slowly
	player.y_speed+=player.gravity
	
	-- flap when up is pressed
	if(btnp(btn_up)) then
		player.y_speed-=player.dy_up
		sfx(player.sfx_up)
	end
	
	-- move vertically
	player.y+=player.y_speed
	
	-- update score
	player.score+=player.x_speed
end

function check_hit()
	for i=player.x,player.x+7 do
		if(cave.cols[i+1].top>player.y or
					cave.cols[i+1].btm<player.y+7) then
			game_over=true
			sfx(player.sfx_dead)
		end
	end
end
-->8
function make_cave()
	cave_parallax=make_wave(55,75)
	cave=make_wave(45,85)
end

function update_cave()
	update_wave(cave_parallax,player.x_speed/2)
	update_wave(cave,player.x_speed)
end

function draw_cave()
	parallax_background_color=5
	draw_wave(cave_parallax,
											parallax_background_color)


	background_color=4
	border_color=0
	border_width=1
	draw_wave(cave,
											background_color,
											border_color,
											border_width)
	
end
-->8
function add_col(wave)
	local col={}
	if(#wave.cols==0)then
		col.top=3
		col.btm=124
	else
		local up=flr(rnd(7)-3)
		local dwn=flr(rnd(7)-3)
		col.top=mid(
				3,
		  wave.cols[#wave.cols].top+up,
		  wave.max_top)
		col.btm=mid(
				wave.max_btm,
		  wave.cols[#wave.cols].btm+dwn,
		  124)
	end
	add(wave.cols,col)
end

function fill_wave(wave)
	while(#wave.cols<wave.width) do
		add_col(wave)
	end
end

function make_wave(max_top,
                   max_btm)
	wave={}
	wave.cols={}
	wave.max_top=max_top
	wave.max_btm=max_btm
	wave.width=128
	wave.height=128		
	fill_wave(wave)
	
	return wave
end

function update_wave(wave,speed)
	--remove from the left
	if(#wave.cols>speed) then
		for i=1,speed do
			del(wave.cols, wave.cols[1])
		end
	end
	
	--add to the right
	fill_wave(wave)
end

function draw_wave(wave,
                   background,
                   border,
                   border_width)
	for i=1,#wave.cols do
	 local col_top=wave.cols[i].top
	 local col_btm=wave.cols[i].btm
		line(i-1,
							0,
							i-1,
							col_top,
							background)
		line(i-1,
							wave.height-1,
							i-1,
							col_btm,
							background)
		if(border!=nil)then
			line(i-1,
								col_top-border_width,
								i-1,
								col_top,
								border)
			line(i-1,
								col_btm+border_width,
								i-1,
								col_btm,
								border)
		end
	end
end
-->8
btn_x=5
btn_up=2
sfx_all=-1
sfx_stop=-1

function print_center(s,y,c)
	print(s,64-#s*2,y,c)
end

function sfx_stop_all()
	sfx(sfx_all, sfx_stop)
end
__gfx__
00000000a0000000a0000000a0000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000aaa00000aaa00000aaa00660101001010010010000100100000000000000000000000000000000000000000000000000000000000000000000000000
0070070089aaaa0089aaaa0000aaaa60111111110111111001111110000000000000000000000000000000000000000000000000000000000000000000000000
0007700088a00aa088a00aa000a00aa6017117100171171001811810000000000000000000000000000000000000000000000000000000000000000000000000
0007700089aaaaaa89aaaaaaa05aaa56001111001111111101111110000000000000000000000000000000000000000000000000000000000000000000000000
00700700aaaaaaa0aaaaaaa00aaaaaa6000110001001100100011000000000000000000000000000000000000000000000000000000000000000000000000000
00000000098889000000000000665660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000009890000000000000006500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__label__
44444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444
44444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444
04044444444444404440404444444004444444444444444444444444444444444444444444400440044444040004000404444444444444444444444444444444
00044404444444000400404444444000444444444444444444444444444444444444444444000400044444040000000400444444444444444444444444444444
00044400444444050405450444440550444444444444444444444444444444444444404440055005544440505550555050044444444444444444444444444444
05004050444444555455050444400555444444444444444444444444444444444444004440555055504440505555555055044444444004444444444444444444
00004055444440555055055044405555044444444444444444444444444444444444054445555555500445555555555555504444444004444444444444444444
00004555004400555055555000055555044444444444444444444444044040444440550405555555550405555555555555504444440550044444444444444444
00000555004005555555555500055555504444444444444444444444004040440440550405555555555405555555555555554444400550004444444444444444
00000555550055555555555555555555504444444444444444444444504505040405555055555555555055555555555555550444405555504444444444444444
00000505550555555555555555555555554444444444444444444040550505005005555055555555555055555555555555550444455555550044444444444444
00000505555555555555555555555555550444444444444444444040550555505055555555555555555555555555555555555444055555550044444444444444
00000005555555555555555555555555550444444444444000404505555555555555555555555555555555555555555555555000055555555504444444444444
00000000555555555555555555555555555044444444444000000505555555555555555555555555555555555555555555555000555555555504444444444444
00000000550555555555555555555555555044040444440555050555555555555555555555555555555555555555555555555555555555555554444444444444
00000000000555555555555555555555555500000444040555555555555555555555555555555555555555555555555555555555555555555550044444444444
00000000000055555505555555050555555500505400040550555555555555555555555555555555555555555555555555555555555555555550044444444444
00000000000000555505550550050055555555555000500050555555555555555555555555555555555555555555555555555555555555555555544444444444
00000000000000555505550550050055555555555055000050055555555555555555555555555555555555555555555555555555555555555555500444444444
00000000000000555000050000000055555555555500000000005555555555555555555555555555555555555555555555555555555555555555500444444444
00000000000000005000000000000000555555555500000000005555555555555555555555555555555555555555555555555555555555555555555444400444
00000000000000005000000000000000555555555500000000000555555555555555555555555555555555555555555555555555555555555555555044400044
00000000000000000000000000000000555555555000000000000055555555555555555555555555555555555555555555555555555555555555555044055044
00000000000000000000000000000000055555055000000000000055555005555555555555555505555555555555555555555555555555555555555544055544
00000000000000000000000000000000005555055000000000000055555000555555555555550005555555555555555555555555555555555555555504555500
00000000000000000000000000000000005550000000000000000005550000555555555555550000555555555055555555555555555555555555555500555500
00000000000000000000000000000000005500000000000000000005550000555555555555500000505555055055555555555555555555555555555550555555
00000000000000000000000000000000000000000000000000000005500000000555555555500000005055055055505555555555555555555555555555555555
00000000000000000000000000000000000000000000000000000000500000000555555555500000000055050005000555555555555555555555555555555555
00000000000000000000000000000000000000000000000000000000500000000555555505000000000000000005000055555555555555555555555555555555
00000000000000000000000000000000000000000000000000000000000000000055555505000000000000000005000005555555555555555555555555555555
00000000000000000000000000000000000000000000000000000000000000000055555000000000000000000000000005555555555555555055555555555555
00000000000000000000000000000000000000000000000000000000000000000005555000000000000000000000000005555555555555555055555555555555
00000000000000000000000000000000000000000000000000000000000000000005555000000000000000000000000000050055555055555000055555555555
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000055550005550000055555555555
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000550005000000055555555505
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000550000000000005555555505
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000500000000000005555055000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005005050000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000077707770777000000770777070707770000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000070707070070000007000707070707000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000077007770070000007000777070707700000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000070707070070000007000707077707000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000077707070070000000770707007007770000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000666066606660066006600000066666000000666006600000066066606660666066600000000000000000000000000000
00000000000000000000000000000000606060606000600060000000660606600000060060600000600006006060606006000000000000000000000000000000
00000000000000000000000000000000666066006600666066600000666066600000060060600000666006006660660006000000000000000000000000000000
00000000000000000000000000000000600060606000006000600000660606600000060060600000006006006060606006000000000000000000000000000000
00000000000000000000000000000000600060606660660066000000066666000000060066000000660006006060606006000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000100100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000001111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000001711710000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000011111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000010011001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000500000004
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000500000044
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005550000500000044
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005555505550000044
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000050000000000005555505550000444
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000050000005005055555505504000444
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000055000005505055555555504404444
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000055555000055505555555555544404444
00000000005000000000000000000000000000000000000000000000000000000000000004000000004400000000000055555000055555555555550044444444
00000000005000000000000000000000000000000000000000000000000000000000000004000000004400000040000405555500055555555555550044444444
00000004005500000000000000000000000000000000000044000000000000000000000004000000044400040040050405505500555555555505004444444444
00000004005500000000000000000000000000005000044044000005050000000000000044400040444444040044050440505500555555555505004444444444
00005044405500000000000000000000000000005500044044000005050000000000000044444044444444440444054440540500055555555540444444444444
00005044445550050000000000000000000000505540044444404005550000000000000044444044444444444444004444040505055555555040444444444444
00000444440050054040000504000000000000555040444444404040555050400500000444444444444444444444404444044040450555505044444444444444
00050444440005004444000544000000050000550044444444444040555054400000400444444444444444444444444444444040400555005444444444444444
00404444444400004444000044000000000000000444444444444444000004440000400444444444444444444444444444444444404000040444444444444444
00404444444440444444404044400000000000004444444444444444000004444440404444444444444444444444444444444444444000440444444444444444
44444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444
44444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444

__map__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0909090909090909090909090909090900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
000400000e05012050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000003305000000250500000019050000000d05005000050500505005040050400403003030030300203001020010200101001010000000000000000000000000000000000000000000000000000000000000
001000000f0500f05014050140500f0500f05014050140500f0500f05014050140500f0500f05014050140500f0500f05014050140500f0500f05014050140500f0500f05014050140500f0500f0501405014050
01101300000002e0503005031050337502d7502e7502b7502575016750077500b7500c75015750187501d7501275017750157501475013750127500f7501075013750167501d750257502d7502b7502675021750
__music__
04 02034344

